@baseUrl = http://localhost:3000
@authToken = {{login.response.body.access_token}}

### ============================================================================
### M√ìDULO: AG√äNCIAS (CRUD + PAGINA√á√ÉO)
### ============================================================================

### 1. Criar Ag√™ncia 1 (Matriz)
POST {{baseUrl}}/agencies
Content-Type: application/json

{
  "name": "FleetVF Matriz",
  "city": "S√£o Paulo",
  "state": "SP",
  "address": "Av. Paulista, 1000"
}

### 2. Criar Ag√™ncia 2 (Filial Rio)
POST {{baseUrl}}/agencies
Content-Type: application/json

{
  "name": "FleetVF Rio",
  "city": "Rio de Janeiro",
  "state": "RJ",
  "address": "Av. Atl√¢ntica, 500"
}

### 3. Listar Ag√™ncias (Padr√£o)
# Deve retornar { data: [...], count: X, limit: 10, offset: 0 }
GET {{baseUrl}}/agencies

### 4. Listar Ag√™ncias (Com Pagina√ß√£o)
# Pede apenas 1 registro, pulando 0. √ötil para testar se o "count" vem certo.
GET {{baseUrl}}/agencies?limit=1&offset=0

### 5. Atualizar Ag√™ncia
# Substitua '1' pelo ID da Matriz se necess√°rio
PATCH {{baseUrl}}/agencies/2
Content-Type: application/json

{
  "name": "FleetVF Matriz Global",
  "address": "Av. Paulista, 2000"
}

### 6. Deletar Ag√™ncia
# (Cuidado: s√≥ delete se n√£o for usar nos testes abaixo)
DELETE {{baseUrl}}/agencies/9


### ============================================================================
### M√ìDULO: CARROS (CRUD + PAGINA√á√ÉO)
### ============================================================================

### 7. Criar Carro 1 (Civic - Ag√™ncia 1)
POST {{baseUrl}}/cars
Content-Type: application/json

{
  "model": "Honda Civic Touring",
  "brand": "Honda",
  "licensePlate": "CIV-2024",
  "dailyRate": 350.00,
  "currentMileage": 1000,
  "status": "AVAILABLE",
  "imageUrl": "https://grandbrasil.com.br/wp-content/uploads/2019/09/CorollaXei2024.png",
  "agencyId": "23cd565c-1dc6-42f0-ad09-d6e795833854"
}
###

# -------------------------------------------------------
# TESTE 2: Sucesso (Status Expl√≠cito)
# Enviamos 'MAINTENANCE', ele deve aceitar
# -------------------------------------------------------
POST {{baseUrl}}/cars
Content-Type: application/json

{
  "model": "Civic Quebrado",
  "brand" : "Honda",
  "licensePlate": "CIV-2222",
  "dailyRate": 250.00,
  "currentMileage": 10000,
  "agencyId": 3,
  "status": "MAINTENANCE"
}

### 8. Criar Carro 2 (Corolla - Ag√™ncia 2)
POST {{baseUrl}}/cars
Content-Type: application/json

{
  "model": "tiger XEi",
  "brand": "Toyota",
  "licensePlate": "COR-2025",
  "dailyRate": 320.00,
  "currentMileage": 500,
  "status": "AVAILABLE",
  "imageUrl": "https://image1.mobiauto.com.br/images/api/images/v1.0/219699978/transform/fl_progressive,f_webp,q_auto",
  "agencyId": 3
}

### 9. Listar Carros (Padr√£o)
# Deve retornar estrutura paginada
GET {{baseUrl}}/cars

### 10. Listar Carros (Pagina√ß√£o Espec√≠fica)
# Traz 5 carros, pulando os 2 primeiros (offset=2)
GET {{baseUrl}}/cars?limit=5&offset=2

### 2. Testar a Busca (Por Exemplo: Civic)
GET http://localhost:3000/cars?search=Renault

### 3. Testar a Busca + Pagina√ß√£o
GET http://localhost:3000/cars?search=Civic&limit=2&offset=0
### 11. Buscar Carro √önico
# Substitua pelo ID real de um carro criado
GET {{baseUrl}}/cars/4

### 12. Deletar Carro
DELETE {{baseUrl}}/cars/16


### ============================================================================
### REGRAS DE NEG√ìCIO E VALIDA√á√ïES (Onde o sistema brilha)
### ============================================================================

### 13. ERRO: Quilometragem Menor (Anti-Fraude)
# Tenta baixar a KM de 1000 para 500.
# Esperado: 400 Bad Request
PATCH {{baseUrl}}/cars/16
Content-Type: application/json

{
  "currentMileage": 1
}

### 14. BLINDAGEM: Tentar mudar Placa
# O sistema deve ignorar 'licensePlate' e atualizar s√≥ o pre√ßo.
# Esperado: 200 OK (mas a placa n√£o muda no banco)
PATCH {{baseUrl}}/cars/16
Content-Type: application/json

{
  "licensePlate": "FAKE-1234",
  "dailyRate": 999.00
}

### 15. ERRO: Ag√™ncia Inexistente (Integridade)
# Tenta vincular a uma ag√™ncia fantasma.
# Esperado: 404 Not Found
PATCH {{baseUrl}}/cars/16
Content-Type: application/json

{
  "agencyId": 99999
}

### ============================================================================
### TESTE DE INTEGRIDADE: "O EXPURGO" (Dele√ß√£o de Ag√™ncia)
### ============================================================================

### 16. Prepara√ß√£o: Criar Ag√™ncia Tempor√°ria
POST {{baseUrl}}/agencies
Content-Type: application/json

{
  "name": "Ag√™ncia Condenada",
  "city": "Silent Hill",
  "state": "SP",
  "address": "Rua do Nevoeiro, 0"
}
# ‚ö†Ô∏è ANOTE O ID QUE RETORNAR AQUI (ex: ID 50)

### 17. Prepara√ß√£o: Criar Carro vinculado a ela
# ‚ö†Ô∏è USE O ID DA AG√äNCIA CRIADA ACIMA
POST {{baseUrl}}/cars
Content-Type: application/json

{
  "model": "Carro √ìrf√£o",
  "brand": "Fiat",
  "licensePlate": "RIP-9999",
  "dailyRate": 50.00,
  "currentMileage": 0,
  "agencyId": 50
}
# ‚ö†Ô∏è ANOTE O ID DO CARRO (ex: ID 20)

### 18. A√á√ÉO: Deletar a Ag√™ncia
# ‚ö†Ô∏è USE O ID DA AG√äNCIA (ex: 50)
DELETE {{baseUrl}}/agencies/50

### 19. VERIFICA√á√ÉO FINAL: O carro sobreviveu?
# ‚ö†Ô∏è USE O ID DO CARRO (ex: 20)
# Esperado: O carro existe, mas "agency": null
GET {{baseUrl}}/cars/20

# ==========================================
# üöÄ 1. CRIA√á√ÉO DE USU√ÅRIOS (POST)
# ==========================================

### 1.1 Criar um ADMIN (Caminho Feliz)
# Esperado: 201 Created. O campo 'password' N√ÉO deve vir na resposta.
# Copie o ID retornado aqui para usar nos pr√≥ximos testes.
POST {{baseUrl}}/users
Content-Type: application/json

{
    "name": "Victor Admin",
    "email": "admin@fleetvf.com",
    "password": "SuperStrongPassword123!",
    "role": "ADMIN"
}

### 1.2 Criar um CLIENTE (Role Padr√£o)
# Esperado: 201 Created. Role deve ser 'CLIENT' automaticamente.
POST {{baseUrl}}/users
Content-Type: application/json

{
    "name": "Cliente Jo√£o",
    "email": "joao@cliente.com",
    "password": "SuperStrongPassword123!"
}

### 1.3 Teste de Erro: Senha Fraca
# Esperado: 400 Bad Request (Password too weak)
POST {{baseUrl}}/users
Content-Type: application/json

{
    "name": "Hacker Pregui√ßoso",
    "email": "hacker@fail.com",
    "password": "123"
}

### 1.4 Teste de Erro: Email Duplicado
# Esperado: 409 Conflict (Email j√° cadastrado)
# Tente rodar o teste 1.1 novamente para ver este erro.
POST {{baseUrl}}/users
Content-Type: application/json

{
    "name": "Impostor",
    "email": "admin@fleetvf.com",
    "password": "OutraSenha123!"
}

# ==========================================
# üîç 2. LEITURA (GET)
# ==========================================

### 2.1 Listar Todos
# Esperado: 200 OK. Lista de usu√°rios. Verifique se as senhas sumiram.
GET {{baseUrl}}/users

### 2.2 Buscar por ID (Substitua o UUID abaixo)
@userId = cole-o-uuid-aqui-sem-aspas
GET {{baseUrl}}/users/{{ba971a63-6412-45c3-bb3f-97c9c1bc2d1d}}

### 2.3 Teste de Erro: UUID Inv√°lido
# Esperado: 400 Bad Request (Validation failed (uuid is expected))
GET {{baseUrl}}/users/123

# ==========================================
# üìù 3. ATUALIZA√á√ÉO (PATCH)
# ==========================================

### 3.1 Atualizar Nome e Email
# Esperado: 200 OK. Dados atualizados.
PATCH {{baseUrl}}/users/ba971a63-6412-45c3-bb3f-97c9c1bc2d1d
Content-Type: application/json

{
    "name": "Victor Fares Admin",
    "email": "victor.admin@fleetvf.com"
}

### 3.2 Teste de Seguran√ßa: Tentar mudar a senha por aqui
# Esperado: 200 OK, MAS a senha N√ÉO deve mudar no banco.
# O DTO removeu o campo 'password', ent√£o o backend ignora.
PATCH {{baseUrl}}/users/ba971a63-6412-45c3-bb3f-97c9c1bc2d1d
Content-Type: application/json

{
    "password": "123"
}

### 3.3 Teste de Conflito: Usar email de outro
# Crie o usu√°rio do teste 1.2 primeiro. Tente mudar o admin para o email do joao.
# Esperado: 409 Conflict
PATCH {{baseUrl}}/users/ba971a63-6412-45c3-bb3f-97c9c1bc2d1d
Content-Type: application/json

{
    "email": "joao@cliente.com"
}

# ==========================================
# üóëÔ∏è 4. REMO√á√ÉO (DELETE)
# ==========================================

### 4.1 Soft Delete
# Esperado: 200 OK.
DELETE {{baseUrl}}/users/ba971a63-6412-45c3-bb3f-97c9c1bc2d1d

### 4.2 Verificar se sumiu
# Esperado: 404 Not Found (pois o findOne padr√£o ignora deletados)
GET {{baseUrl}}/users/ba971a63-6412-45c3-bb3f-97c9c1bc2d1d

Chegou a hora de ver a m√°gica acontecer! üïµÔ∏è‚Äç‚ôÇÔ∏è‚ú®

Como voc√™ resetou o banco para usar UUIDs, certifique-se de que voc√™ criou o usu√°rio novamente antes de tentar logar.

Aqui est√° o arquivo api.rest atualizado com os cen√°rios de teste para Autentica√ß√£o.

üìÑ Atualize seu arquivo api.rest (ou users.http)
Copie e cole isso no seu arquivo de testes.

HTTP

@baseUrl = http://localhost:3000

# ==========================================
# üõ†Ô∏è PREPARA√á√ÉO (CRIAR USU√ÅRIO)
# ==========================================

### 1. Criar Usu√°rio Admin (Se ainda n√£o existir)
# Precisamos dele para testar o login
POST {{baseUrl}}/users
Content-Type: application/json

{
    "name": "Victor Admin",
    "email": "admin@fleetvf.com",
    "password": "SuperStrongPassword123!",
    "role": "ADMIN"
}

# ==========================================
# üîê AUTENTICA√á√ÉO (LOGIN)
# ==========================================

### 2. Login com Sucesso (Caminho Feliz)
# Esperado: 200 OK
# Retorna: access_token + dados do usu√°rio
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "admin@fleetvf.com",
    "password": "SuperStrongPassword123!"
}

### 3. Erro: Senha Incorreta
# Esperado: 401 Unauthorized
# Mensagem: "Email ou senha inv√°lidos" (Gen√©rica por seguran√ßa)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "admin@fleetvf.com",
    "password": "SenhaErrada123"
}

### 4. Erro: Email Inexistente
# Esperado: 401 Unauthorized
# Mensagem: "Email ou senha inv√°lidos" (Mesma mensagem da senha errada)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "fantasma@fleetvf.com",
    "password": "QualquerSenha"
}

### 1. Fazer Login (Deve funcionar sem token)
# @name login
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "admin@fleetvf.com",
    "password": "SuperStrongPassword123!"
}

# ==========================================
# üî¥ 2. TESTE DE BLOQUEIO (SEM TOKEN)
# ==========================================

### 2. Tentar acessar Usu√°rios SEM Token
# OBJETIVO: Testar se o Guard Global est√° ativo.
# ESPERADO: 401 Unauthorized
GET {{baseUrl}}/users

# ==========================================
# üü¢ 3. TESTE DE ACESSO (COM TOKEN)
# ==========================================

### 3. Acessar Usu√°rios COM Token
# OBJETIVO: Testar se a Strategy valida o token corretamente.
# Copie o token do passo 1 e cole abaixo depois de "Bearer"
GET {{baseUrl}}/users
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjZWNlMmUyZi1iOTVlLTQzY2QtOTY5Ni04ZDYzYTliNTgwYzQiLCJlbWFpbCI6ImFkbWluQGZsZWV0dmYuY29tIiwicm9sZSI6IkFETUlOIiwibmFtZSI6IlZpY3RvciBBZG1pbiIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlhdCI6MTc3MDc0NDMwMiwiZXhwIjoxNzcwNzQ3OTAyfQ.yGDBpoZ0CHiLfR_2ISulnVh_Oe_C9aw3hF7KjJSQgIs

# ==========================================
# üïµÔ∏è‚Äç‚ôÇÔ∏è 4. TESTE DE PERFIL (CURRENT USER)
# ==========================================

### 4. Ver dados do usu√°rio logado (Se voc√™ criou a rota /me)
GET {{baseUrl}}/users/me
Authorization: Bearer COLA_SEU_TOKEN_GIGANTE_AQUI


# ==========================================
# üé≠ CEN√ÅRIO DE TESTE DE ROLES (RBAC)
# ==========================================

### 1. [ADMIN] Criar um Usu√°rio "Cliente" (Para testar o bloqueio)
# Use o token do Admin aqui (que j√° tem permiss√£o)
POST {{baseUrl}}/users
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjZWNlMmUyZi1iOTVlLTQzY2QtOTY5Ni04ZDYzYTliNTgwYzQiLCJlbWFpbCI6ImFkbWluQGZsZWV0dmYuY29tIiwicm9sZSI6IkFETUlOIiwibmFtZSI6IlZpY3RvciBBZG1pbiIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlhdCI6MTc3MDc0NTg2MywiZXhwIjoxNzcwNzQ5NDYzfQ.ZVCd_ixvhFFF03nTGvOu6R0XLoJTAcK85VGR_bT1Dco

{
    "name": "Jo√£o Cliente",
    "email": "client@fleetvf.com",
    "password": "ClientPassword123!",
    "role": "CLIENT" 
}

### 2. [CLIENT] Fazer Login como Cliente
# @name clientLogin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "client@fleetvf.com",
    "password": "ClientPassword123!"
}

### 3. [CLIENT] Tentar Criar um Usu√°rio (Deve FALHAR)
# O Cliente vai tentar fazer algo que s√≥ Admin pode.
# ESPERADO: 403 Forbidden
POST {{baseUrl}}/users
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0MTU3Nzk1Yy1lMmQ0LTQwZTQtYjc0Mi0xMTNkMmUxYjE0YjciLCJlbWFpbCI6ImNsaWVudEBmbGVldHZmLmNvbSIsInJvbGUiOiJDTElFTlQiLCJuYW1lIjoiSm_Do28gQ2xpZW50ZSIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlhdCI6MTc3MDc0NTg5NCwiZXhwIjoxNzcwNzQ5NDk0fQ.itTZ-peVK871mO1Nzg8QZn_QxoZ3N3kipzaqbixqld4

{
    "name": "Hacker Tentando Entrar",
    "email": "hacker@fleetvf.com",
    "password": "123",
    "role": "ADMIN"
}

Excelente! O fluxo de Sign Up (Auto-cadastro) √© um dos mais cr√≠ticos para testar, pois precisamos garantir que a "porta de entrada" funciona, mas que ningu√©m entra com privil√©gios de administrador indevidamente.

Vamos testar 3 cen√°rios no seu api.rest.

üìÑ Atualize seu api.rest
Adicione estes blocos no final do arquivo. Eles testam o ciclo completo: Cadastro -> Tentativa de Fraude -> Login com a conta nova.

HTTP

# ==========================================
# üÜï CEN√ÅRIO: AUTO-CADASTRO (SIGN UP)
# ==========================================

### 1. Criar Conta (Sucesso)
# O usu√°rio comum se cadastra.
# ESPERADO: 201 Created + Objeto do usu√°rio (role deve ser CLIENT)
POST {{baseUrl}}/auth/signup
Content-Type: application/json

{
    "name": "Cliente Novo da Silva",
    "email": "cliente.novo@gmail.com",
    "password": "SenhaForte123!"
}

### 2. Tentativa de Hacker (Inje√ß√£o de Role)
# Tenta criar um usu√°rio for√ßando ser ADMIN.
# COMO VALIDAR:
# Op√ß√£o A: Se o DTO estiver com 'forbidNonWhitelisted: true', d√° erro 400 (Melhor caso).
# Op√ß√£o B: Se aceitar, a resposta DEVE voltar com "role": "CLIENT" (O service ignorou o admin).
POST {{baseUrl}}/auth/signup
Content-Type: application/json

{
    "name": "Hacker Esperto",
    "email": "hacker.novo@gmail.com",
    "password": "SenhaForte123!",
    "role": "ADMIN"
}

### 3. Testar Login com a Nova Conta
# Verifica se o usu√°rio criado no passo 1 consegue pegar token.
# ESPERADO: 200 OK + Token JWT
# @name novoLogin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "cliente.novo@gmail.com",
    "password": "SenhaForte123!"
}

### 4. Verificar Permiss√µes (Acesso Negado)
# Tenta criar um carro usando o token do novo cliente.
# ESPERADO: 403 Forbidden (O sistema reconheceu que ele √© CLIENT)
POST {{baseUrl}}/cars
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjODk0MmYwYi1iODMyLTQwYmMtODYxNS1mODY2ZGE2NjZhZjYiLCJlbWFpbCI6ImNsaWVudGUubm92b0BnbWFpbC5jb20iLCJyb2xlIjoiQ0xJRU5UIiwibmFtZSI6IkNsaWVudGUgTm92byBkYSBTaWx2YSIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCIsImlhdCI6MTc3MDc0Njk1NSwiZXhwIjoxNzcwNzUwNTU1fQ.681TAGAAnIxb2McT9R2RnRiswjwPM07Pjy2sdwD4z54

{
    "brand": "Ferrari",
    "model": "F8",
    "year": 2024,
    "licensePlate": "NOV-1234",
    "color": "Red",
    "dailyRate": 5000
}